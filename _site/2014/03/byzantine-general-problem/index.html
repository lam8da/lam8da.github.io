<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="lambda" />
    <title>拜占庭将军问题 | lambda</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <link href="http://localhost:4000/feed/" rel="alternate" title="lambda" type="application/atom+xml" />
    <link rel="stylesheet" href="/media/css/style.css">
    <link rel="stylesheet" href="/media/css/highlight.css">
    <link rel="stylesheet" href="/media/css/highlighter-rouge.css">
    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        "HTML-CSS": { scale: 80 }
      });
    </script>
    <script type="text/javascript" async src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </head>
  <body>
    <div id="container">
      <div id="main" role="main">
        <header>
        <h1>拜占庭将军问题</h1>
        </header>
        <nav>
        <span><a title="home page" class="" href="http://localhost:4000/">首页</a></span>
        <span><a title="categories" class="" href="http://localhost:4000/categories/">分类</a></span>
        <span><a title="tags" class="" href="http://localhost:4000/tags/">标签</a></span>
        <span><a title="links" class="" href="http://localhost:4000/links/">链接</a></span>
        <span><a title="about" class="" href="http://localhost:4000/about/">关于</a></span>
        <span><a title="subscribe by RSS" class="" href="http://localhost:4000/feed/">订阅</a></span>
        </nav>
        <article class="content">
        <section class="post">
<p>工作之余，花了一周的几乎每个晚上把Lamport神的那篇有关拜占庭将军问题的文章看完了。在这里做下笔记。</p>

<p>个人觉得最难懂的就是OM算法，我将它理解成一个动态规划：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="c1">// @c is the commander id;
// @l is one of the lieutenant id, which belongs to the current lieutenant set;
// @m is the parameter m mentioned in the paper;
// OM(c, l, m) means the final value lieutenant @l obeys from commander @c.
</span>
<span class="o">-</span> <span class="k">if</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="o">:</span>
<span class="n">OM</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">=</span> <span class="n">msg</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">),</span> <span class="n">where</span> <span class="n">l</span> <span class="n">in</span> <span class="n">set</span><span class="p">{</span><span class="n">lieutenant</span><span class="p">};</span>

<span class="o">-</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">:</span>
<span class="n">OM</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">=</span> <span class="n">majority</span><span class="p">(</span>
  <span class="n">msg</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">),</span>
  <span class="n">the</span> <span class="n">list</span> <span class="n">of</span> <span class="n">OM</span><span class="p">(</span><span class="n">l</span><span class="err">'</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">where</span> <span class="n">l</span><span class="err">'</span> <span class="n">in</span> <span class="p">(</span><span class="n">set</span><span class="p">{</span><span class="n">lieutenant</span><span class="p">}</span> <span class="o">-</span> <span class="p">{</span><span class="n">l</span><span class="p">})</span>
<span class="p">).</span>  <span class="c1">// majority
</span></pre></td></tr></tbody></table>
</div>
</div>

<p>实际上，准确来说上面的状态表示是不完全的，OM的第一个参数应该是一个commander的id列表，表示从算法开始的第一个commander通过发消息沿途产生的所有commander。这样说起来还是很抽象，具体还是看下文代码吧。</p>

<p>为了让自己有更深的理解，我用C++实现了一个模拟器，输入general的个数，指定commander是否loyal，模拟算法运行，打印出每条消息以及消息路径，最后得出每个忠诚的lieutenant遵守的命令。目测+用小数据测试没有发现错误，也贴在这里供以后回顾使用。</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208</pre></td><td class="code"><pre><span class="cp">#include &lt;cstdlib&gt;
#include &lt;cstdio&gt;
#include &lt;iostream&gt;
#include &lt;vector&gt;
#include &lt;set&gt;
#include &lt;map&gt;
#include &lt;string&gt;
</span> 
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>
 
<span class="kt">int</span> <span class="n">num_generals</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">commander_is_loyal</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">is_loyal</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
 
<span class="k">typedef</span> <span class="kt">int</span> <span class="n">ValueType</span><span class="p">;</span>
<span class="k">const</span> <span class="n">ValueType</span> <span class="n">kDefaultValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999999999</span><span class="p">;</span>
 
<span class="c1">// Classic algorithm to find the majority: maintain a value and
// a counter, when see a same value, ++counter; otherwise, if
// counter is 0, set the value to the one we see and let counter=1,
// or if counter&gt;0, --counter.
</span><span class="k">struct</span> <span class="n">MajorityCount</span> <span class="p">{</span>
  <span class="n">ValueType</span> <span class="n">majority</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">seen</span><span class="p">;</span>
 
  <span class="n">MajorityCount</span><span class="p">()</span> <span class="o">:</span> <span class="n">majority</span><span class="p">(</span><span class="n">kDefaultValue</span><span class="p">),</span> <span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">seen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
  <span class="n">MajorityCount</span><span class="p">(</span><span class="k">const</span> <span class="n">ValueType</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">s</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">majority</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">count</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">seen</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{}</span>
 
  <span class="n">MajorityCount</span><span class="o">&amp;</span> <span class="n">Merge</span><span class="p">(</span><span class="k">const</span> <span class="n">MajorityCount</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">++</span><span class="n">seen</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">majority</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="n">majority</span><span class="p">;</span>
      <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">majority</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">majority</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">++</span><span class="n">count</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="o">--</span><span class="n">count</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">Print</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">": val="</span> <span class="o">&lt;&lt;</span> <span class="n">majority</span>
         <span class="o">&lt;&lt;</span> <span class="s">", cnt="</span> <span class="o">&lt;&lt;</span> <span class="n">count</span>
         <span class="o">&lt;&lt;</span> <span class="s">", seen="</span> <span class="o">&lt;&lt;</span> <span class="n">seen</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="k">typedef</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">MajorityCount</span><span class="o">&gt;</span> <span class="n">MapType</span><span class="p">;</span>
<span class="n">MapType</span> <span class="n">val_storage</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">RandomShuffle</span><span class="p">(</span><span class="kt">bool</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">begin</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">begin</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">begin</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">" "</span><span class="p">);</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="n">string</span> <span class="nf">Itoa</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">res</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">std</span><span class="o">::</span><span class="n">sprintf</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="n">string</span> <span class="nf">Join</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="o">&amp;</span> <span class="n">begin</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="o">&amp;</span> <span class="n">end</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">delim</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">string</span> <span class="n">res</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="n">res</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">delim</span><span class="p">);</span>
    <span class="n">res</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">Itoa</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="n">ValueType</span> <span class="nf">RandomValue</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// return std::rand() % 97;
</span>  <span class="k">return</span> <span class="mi">250</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="c1">// Updates the value of OM(c, l, m) using OM(l', l, m-1).
</span><span class="kt">void</span> <span class="nf">MergeUp</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">passed_ids</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">remaining_ids</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">key_vec</span> <span class="o">=</span> <span class="n">passed_ids</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">back</span> <span class="o">=</span> <span class="n">key_vec</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
  <span class="n">string</span> <span class="n">src_key</span> <span class="o">=</span> <span class="n">Join</span><span class="p">(</span><span class="n">key_vec</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">key_vec</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="s">"-"</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">required_num_seen</span> <span class="o">=</span> <span class="n">remaining_ids</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
 
  <span class="k">while</span> <span class="p">(</span><span class="n">key_vec</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">key_vec</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
    <span class="n">key_vec</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">=</span> <span class="n">back</span><span class="p">;</span>
    <span class="n">string</span> <span class="n">dst_key</span> <span class="o">=</span> <span class="n">Join</span><span class="p">(</span><span class="n">key_vec</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">key_vec</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="s">"-"</span><span class="p">);</span>
 
    <span class="n">MajorityCount</span> <span class="o">&amp;</span><span class="n">mc</span> <span class="o">=</span> <span class="n">val_storage</span><span class="p">[</span><span class="n">dst_key</span><span class="p">].</span><span class="n">Merge</span><span class="p">(</span><span class="n">val_storage</span><span class="p">[</span><span class="n">src_key</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_loyal</span><span class="p">[</span><span class="n">back</span><span class="p">])</span> <span class="n">mc</span><span class="p">.</span><span class="n">majority</span> <span class="o">=</span> <span class="n">RandomValue</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">seen</span> <span class="o">=</span> <span class="n">mc</span><span class="p">.</span><span class="n">seen</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"    "</span> <span class="o">&lt;&lt;</span> <span class="n">src_key</span> <span class="o">&lt;&lt;</span> <span class="s">" =&gt; "</span> <span class="o">&lt;&lt;</span> <span class="n">dst_key</span><span class="p">;</span>
    <span class="n">mc</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span>
 
    <span class="n">val_storage</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">src_key</span><span class="p">);</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="n">seen</span> <span class="o">==</span> <span class="n">required_num_seen</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">src_key</span> <span class="o">=</span> <span class="n">dst_key</span><span class="p">;</span>
      <span class="o">++</span><span class="n">required_num_seen</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// Sequential algorithm: for simplicity, assume that each lieutenant
// will send messages to others when needed.
</span><span class="kt">void</span> <span class="nf">OM</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">commander_id</span><span class="p">,</span>
        <span class="k">const</span> <span class="n">ValueType</span> <span class="o">&amp;</span><span class="n">received_val</span><span class="p">,</span>
        <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">passed_ids</span><span class="p">,</span>  <span class="c1">// the last one is commander_id.
</span>        <span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">remaining_ids</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// {1, 2, ..., n-1} - passed_ids
</span>  <span class="k">const</span> <span class="n">string</span> <span class="n">prefix_path</span> <span class="o">=</span>
      <span class="n">Join</span><span class="p">(</span><span class="n">passed_ids</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">passed_ids</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">(),</span> <span class="s">"-"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">remaining_ids_copy</span><span class="p">(</span><span class="o">*</span><span class="n">remaining_ids</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">remaining_ids_copy</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="n">it</span> <span class="o">!=</span> <span class="n">remaining_ids_copy</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
      <span class="n">ValueType</span> <span class="n">val_to_send</span> <span class="o">=</span>
        <span class="p">(</span><span class="n">is_loyal</span><span class="p">[</span><span class="n">commander_id</span><span class="p">]</span> <span class="o">?</span> <span class="n">received_val</span> <span class="o">:</span> <span class="n">RandomValue</span><span class="p">());</span>
 
      <span class="c1">// OM(m), step (1)
</span>      <span class="n">string</span> <span class="n">path</span> <span class="o">=</span> <span class="n">prefix_path</span> <span class="o">+</span> <span class="s">"-"</span> <span class="o">+</span> <span class="n">Itoa</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="k">const</span> <span class="n">MajorityCount</span> <span class="o">&amp;</span><span class="n">mc</span> <span class="o">=</span>
        <span class="n">val_storage</span><span class="p">[</span><span class="n">path</span><span class="p">].</span><span class="n">Merge</span><span class="p">(</span>
            <span class="n">MajorityCount</span><span class="p">(</span><span class="n">is_loyal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">val_to_send</span> <span class="o">:</span> <span class="n">RandomValue</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">path</span><span class="p">;</span>
      <span class="n">mc</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span>
 
      <span class="c1">// OM(m), step (2)
</span>      <span class="n">passed_ids</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="n">remaining_ids</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mc</span><span class="p">.</span><span class="n">seen</span> <span class="o">==</span> <span class="n">remaining_ids</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MergeUp</span><span class="p">(</span><span class="o">*</span><span class="n">passed_ids</span><span class="p">,</span> <span class="o">*</span><span class="n">remaining_ids</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">OM</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">val_to_send</span><span class="p">,</span> <span class="n">passed_ids</span><span class="p">,</span> <span class="n">remaining_ids</span><span class="p">);</span>
      <span class="n">remaining_ids</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="n">passed_ids</span><span class="o">-&gt;</span><span class="n">pop_back</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">MergeUp</span><span class="p">(</span><span class="o">*</span><span class="n">passed_ids</span><span class="p">,</span> <span class="o">*</span><span class="n">remaining_ids</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">string</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"+++++++++++++++++++++++++++++++++"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">,</span>
         <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"num_generals: "</span><span class="p">,</span>
         <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">num_generals</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_generals</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"m: "</span> <span class="o">&lt;&lt;</span> <span class="n">m</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
 
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"commander_is_loyal? "</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">tmp</span><span class="p">;</span>
      <span class="n">commander_is_loyal</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'y'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">commander_is_loyal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"y"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="n">val_storage</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">is_loyal</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">is_loyal</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">commander_is_loyal</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="p">;</span> <span class="n">is_loyal</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">;</span> <span class="n">is_loyal</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">RandomShuffle</span><span class="p">(</span><span class="n">is_loyal</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_generals</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"---------------------------------"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
 
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">passed_ids</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">remaining_ids</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_generals</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">remaining_ids</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="c1">// commander_id=0, received_val=618
</span>    <span class="n">OM</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">618</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">passed_ids</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remaining_ids</span><span class="p">);</span>
 
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"---------------------------------"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">MapType</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">val_storage</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="n">it</span> <span class="o">!=</span> <span class="n">val_storage</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
      <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">Print</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>


</section>
<section class="meta">
<span class="author">
  <a href="http://lam8da.github.io">lambda</a>
</span>
<span class="time">
  /
  <time datetime="2014-03-08">2014-03-08</time>
</span>
<br />
<span class="license">
  Published under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a>
</span>

<span class="categories">
  in categories
  
  <a href="http://localhost:4000/categories/#网络&分布式" title="网络&分布式">网络&分布式</a>&nbsp;
  
</span>


<span class="tags">
  tagged with 
  
  <a href="http://localhost:4000/tags/#分布式理论" title="分布式理论">分布式理论</a>&nbsp;
  
  <a href="http://localhost:4000/tags/#一致性" title="一致性">一致性</a>&nbsp;
  
  <a href="http://localhost:4000/tags/#paper" title="paper">paper</a>&nbsp;
  
  <a href="http://localhost:4000/tags/#Work in Progress" title="Work in Progress">Work in Progress</a>&nbsp;
  
</span>

</section>
<section class="comment">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'lambda'; // required: replace example with your forum shortname
    var disqus_url = 'http://localhost:4000/2014/03/byzantine-general-problem/';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


<script type="text/javascript">
$(function() {
    $(document).keydown(
      function(e) {
        if (e.target.nodeName.toUpperCase() != 'BODY') return;
        var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
          
            url = 'http://localhost:4000/2013/09/head-first-design-pattern-notes2/';
          
        } else if (e.which == 39 || e.which == 75) {  // Right arrow and K
          
            url = 'http://localhost:4000/2016/11/welcome-to-jekyll/';
          
        }
        if (url) {
          window.location = url;
        }
      });
})
</script>

        </article>
      </div>
    </div>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1988641-2']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
